<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile - DDRC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/dashboard/css/style.css" />
    <link rel="stylesheet" href="/css/accessibility.css" />
</head>

<body>
    <div id="authLoader" class="auth-loader">
        <div class="spinner"></div>
    </div>

    <div id="mainContent" style="display: none">
        <div id="site-header"></div>

        <div class="dashboard-container" id="main-content" tabindex="-1">
            <div class="breadcrumb">
                <a href="/dashboard">Dashboard</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">Profile</span>
            </div>

            <div class="status-header">
                <h2>My Profile</h2>
            </div>

            <div id="profileContent">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/components/header.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            // Auth check
            const isAuth = await AuthManager.verifyAuth();
            if (!isAuth || AuthManager.getUserInfo()?.type !== 'applicant') {
                window.location.href = '/login';
                return;
            }

            document.getElementById("authLoader").style.display = "none";
            document.getElementById("mainContent").style.display = "block";

            loadProfile();
        });

        async function loadProfile() {
            try {
                const response = await fetch("/api/dashboard/profile", {
                    headers: { Authorization: `Bearer ${AuthManager.getAuthToken()}` }
                });

                if (!response.ok) throw new Error("Failed to load profile");

                const data = await response.json();
                const contentDiv = document.getElementById("profileContent");

                // HTML escape utility to prevent XSS
                function escapeHtml(unsafe) {
                    if (!unsafe) return '';
                    return unsafe
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                }

                let html = '';

                for (const [section, fields] of Object.entries(data)) {
                    html += `
            <div class="profile-section">
              <div class="profile-section-header">
                <h3>${escapeHtml(section)}</h3>
              </div>
              <div class="profile-details">
                ${fields.map(field => {
                        let valueHtml = escapeHtml(field.value) || '-';

                        // Check if it's a file field with a token
                        if (field.type === 'file' && field.token && field.value) {
                            const ext = field.value.split('.').pop().toLowerCase();
                            let fileType = 'other';
                            if (['jpg', 'jpeg', 'png'].includes(ext)) fileType = 'image';
                            else if (ext === 'pdf') fileType = 'pdf';

                            const filename = field.value.split(/[/\\]/).pop();
                            const url = `/uploads/forms/${encodeURIComponent(filename)}?access_token=${encodeURIComponent(field.token)}`;
                            const safeTitle = escapeHtml(field.label || 'Document');

                            valueHtml = `<a href="${escapeHtml(url)}" onclick="return openDocument(event, '${escapeHtml(url)}', '${escapeHtml(fileType)}', '${safeTitle}')" class="btn btn-sm btn-outline-primary" target="_blank">View File</a>`;
                        }

                        const isFile = field.type === 'file';

                        return `
                          <div class="detail-item ${isFile ? 'd-flex flex-column h-100' : ''}">
                            <label>${escapeHtml(field.label)}</label>
                            <div class="value ${isFile ? 'mt-auto' : ''}">${valueHtml}</div>
                          </div>
                        `;
                    }).join('')}
              </div>
            </div>
          `;
                }

                contentDiv.innerHTML = html;
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("profileContent").innerHTML = `
          <div class="alert alert-danger">Error loading profile data. Please try again later.</div>
        `;
            }
        }
    </script>
    <script src="/js/components/doc-viewer.js"></script>
    <script src="/js/accessibility.js"></script>
</body>

</html>