<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Media Management | DDRC Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/admin/css/style.css" />
    <style>
        /* Media Gallery Grid */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.25rem;
            padding: 1rem;
        }

        .media-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .media-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .media-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }

        .media-item-info {
            padding: 12px;
        }

        .media-item-title {
            font-weight: 600;
            color: #344767;
            margin-bottom: 4px;
            font-size: 0.95rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .media-item-category {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .media-item-category.events {
            background: #e0f2fe;
            color: #0369a1;
        }

        .media-item-category.camps {
            background: #dcfce7;
            color: #15803d;
        }

        .media-item-category.activities {
            background: #fef3c7;
            color: #b45309;
        }

        .media-item-category.other {
            background: #f1f5f9;
            color: #64748b;
        }

        .media-item-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .media-item:hover .media-item-actions {
            opacity: 1;
        }

        .media-item-actions .btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 6px;
        }

        .featured-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .media-type-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .featured-badge+.media-type-badge,
        .media-type-badge.has-featured {
            left: auto;
            right: 60px;
        }

        .media-item video {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }



        .media-type-tabs {
            display: flex;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .media-type-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .media-type-tab:not(:last-child) {
            border-right: 1px solid #e2e8f0;
        }

        .media-type-tab:hover {
            background: #f8fafc;
        }

        .media-type-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .media-type-tab svg {
            width: 18px;
            height: 18px;
        }

        /* Category Filters */
        .category-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .category-filter-btn {
            padding: 6px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-filter-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .category-filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary-color);
            background: #f8fafc;
        }

        .upload-area svg {
            width: 48px;
            height: 48px;
            color: #94a3b8;
            margin-bottom: 1rem;
        }

        .upload-area.dragover svg {
            color: var(--primary-color);
        }

        /* Image Preview */
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        .image-preview.visible {
            display: block;
        }

        /* Alerts Container */
        .alerts-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 350px;
        }

        /* Loading State */
        .media-grid-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        /* Empty State */
        .media-grid-empty {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .media-grid-empty svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            color: #cbd5e1;
        }
    </style>
</head>

<body>
    <!-- Auth check loader -->
    <div id="authLoader" class="auth-loader">
        <div class="spinner"></div>
    </div>

    <!-- Main content will be hidden until auth check -->
    <div id="mainContent" style="display: none">
        <div class="admin-top-bar">
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="left-links" id="leftLinks">
                <a href="/admin/dashboard/">Dashboard</a>
                <a href="/admin/reports/">Reports</a>
                <a href="/admin/forms/">Form Management</a>
                <a href="/admin/news/">News</a>
                <a href="/admin/events/">Events</a>
                <a href="/admin/schemes/">Schemes</a>
                <a href="/admin/media/" class="active">Media</a>
                <a href="/admin/logbook/">Logs</a>
                <a href="/admin/users/">Users</a>
            </div>
            <div class="right-links">
                <span id="userInfo"></span>
                <button id="logoutBtn" class="btn btn-link" onclick="AuthManager.logout()">
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Header -->
        <header class="main-header">
            <div class="logo-section">
                <img src="/images/emblem.png" alt="Government of India Emblem" class="emblem-logo" />
                <div class="header-text">
                    <!-- Desktop version -->
                    <h1 class="header-title-desktop">District Disability Rehabilitation Centre, Mumbai</h1>
                    <p class="header-subtitle-desktop">Department of Empowerment of Persons with Disabilities,</p>
                    <p class="header-subtitle-desktop">Ministry of Social Justice and Empowerment, Govt. of India</p>

                    <!-- Mobile version -->
                    <h1 class="header-title-mobile">DDRC Mumbai</h1>
                    <p class="header-subtitle-mobile">DEPwD, Ministry of Social Justice & Empowerment, Govt. of India
                    </p>
                </div>
                <img src="/images/ddrc-logo.png" alt="DDRC Logo" class="ddrc-logo" />
            </div>
        </header>

        <div class="admin-content">
            <div class="dashboard-header">
                <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center">
                    <div class="text-start">
                        <h1>Media Gallery</h1>
                        <p class="text-muted mb-0">
                            Upload and manage photos for the public gallery
                        </p>
                    </div>
                    <button class="btn btn-primary mt-3 mt-md-0 d-flex align-items-center gap-2" id="addMediaBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" class="me-2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        Upload Media
                    </button>
                </div>
            </div>

            <!-- Category Filters -->
            <div class="category-filters">
                <button class="category-filter-btn active" data-category="all">All</button>
                <button class="category-filter-btn" data-category="events">Events</button>
                <button class="category-filter-btn" data-category="camps">Medical Camps</button>
                <button class="category-filter-btn" data-category="activities">Activities</button>
                <button class="category-filter-btn" data-category="other">Other</button>
            </div>

            <!-- Media Grid -->
            <div class="content-card">
                <div id="mediaGrid" class="media-grid">
                    <div class="media-grid-loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this image? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Container -->
    <div class="alerts-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/admin/js/admin.js"></script>

    <script>
        // Global variables
        let mediaModal;
        let deleteConfirmModal;
        let currentMediaId = null;
        let currentCategory = 'all';

        // Initialize after DOM is loaded
        document.addEventListener("DOMContentLoaded", async () => {
            // Check authentication
            if (!(await AuthManager.verifyAuth())) {
                window.location.href = "/department-login";
                return;
            }

            // Show main content
            document.getElementById("authLoader").style.display = "none";
            document.getElementById("mainContent").style.display = "block";

            // Set user info
            const userInfo = AuthManager.getUserInfo();
            if (userInfo) {
                document.getElementById("userInfo").textContent = `Welcome, ${userInfo.username}`;
            }

            // Initialize Bootstrap modals
            mediaModal = new bootstrap.Modal(document.getElementById("mediaModal"));
            deleteConfirmModal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));

            // Set up event listeners
            setupEventListeners();

            // Load media data
            await loadMedia();
        });

        // Set up all event listeners
        function setupEventListeners() {
            // Add media button
            document.getElementById("addMediaBtn").addEventListener("click", () => {
                resetMediaForm();
                document.getElementById("mediaModalLabel").textContent = "Upload Media";
                document.getElementById("mediaId").value = "";
                mediaModal.show();
            });

            // Save media button
            document.getElementById("saveMediaBtn").addEventListener("click", handleSaveMedia);

            // Confirm delete button
            document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
                if (currentMediaId) {
                    await deleteMedia(currentMediaId);
                    deleteConfirmModal.hide();
                }
            });

            // Reset form when modal is closed
            document.getElementById("mediaModal").addEventListener("hidden.bs.modal", resetMediaForm);

            // Category filter buttons
            document.querySelectorAll(".category-filter-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".category-filter-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    currentCategory = btn.dataset.category;
                    loadMedia();
                });
            });

            // Media type tabs
            document.querySelectorAll(".media-type-tab").forEach(tab => {
                tab.addEventListener("click", () => {
                    document.querySelectorAll(".media-type-tab").forEach(t => t.classList.remove("active"));
                    tab.classList.add("active");
                    const mediaType = tab.dataset.type;
                    document.getElementById("mediaType").value = mediaType;

                    // Update accepted file types
                    const fileInput = document.getElementById("mediaFile");
                    if (mediaType === 'image') {
                        fileInput.accept = "image/*";
                    } else if (mediaType === 'video') {
                        fileInput.accept = "video/*";
                    }

                    updateMediaTypeSections(mediaType);
                });
            });

            // File input and drag-drop
            const uploadArea = document.getElementById("uploadArea");
            const fileInput = document.getElementById("mediaFile");

            uploadArea.addEventListener("click", () => fileInput.click());

            uploadArea.addEventListener("dragover", (e) => {
                e.preventDefault();
                uploadArea.classList.add("dragover");
            });

            uploadArea.addEventListener("dragleave", () => {
                uploadArea.classList.remove("dragover");
            });

            uploadArea.addEventListener("drop", (e) => {
                e.preventDefault();
                uploadArea.classList.remove("dragover");
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files; // Updates input files
                    handleFilesSelection(files);
                }
            });

            fileInput.addEventListener("change", () => {
                if (fileInput.files.length > 0) {
                    handleFilesSelection(fileInput.files);
                }
            });
        }

        // Update visible sections based on media type
        function updateMediaTypeSections(type) {
            const fileSection = document.getElementById("imageUploadSection");
            const featuredContainer = document.getElementById("featuredCheckContainer");
            const featuredCheckbox = document.getElementById("mediaFeatured");

            // Hide featured option for video
            if (type === "image") {
                featuredContainer.style.display = "block";
            } else {
                featuredContainer.style.display = "none";
                featuredCheckbox.checked = false; // Uncheck if hidden
            }

            // Only toggle file section since YouTube is gone
            fileSection.style.display = "block";
        }



        // Handle selected files (Single or Bulk)
        function handleFilesSelection(files) {
            const imagePreview = document.getElementById("imagePreview");
            const videoPreview = document.getElementById("videoPreview");
            const bulkPreview = document.getElementById("bulkPreview");

            // Reset views
            imagePreview.classList.remove("visible");
            videoPreview.classList.remove("visible");
            videoPreview.style.display = "none";
            bulkPreview.style.display = "none";

            if (files.length > 1) {
                // Bulk Selection
                bulkPreview.innerHTML = `
                    <div class="me-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="18"></line>
                        </svg>
                    </div>
                    <div>
                        <h6 class="mb-0 fw-bold">${files.length} files selected</h6>
                        <small class="text-muted d-block text-truncate" style="max-width: 350px;">
                            ${Array.from(files).map(f => f.name).join(', ')}
                        </small>
                    </div>
                `;
                bulkPreview.style.display = "flex";

                // For bulk, update sections based on first file to be safe
                const firstFile = files[0];
                const isVideo = firstFile.type.startsWith('video/');
                const detectedType = isVideo ? "video" : "image";
                document.getElementById("mediaType").value = detectedType;

                // Update tabs (visual only, strictness doesn't block already selected files)
                document.querySelectorAll(".media-type-tab").forEach(t => {
                    t.classList.toggle("active", t.dataset.type === detectedType);
                });
                updateMediaTypeSections(detectedType);

            } else if (files.length === 1) {
                // Single Selection
                const file = files[0];
                const isVideo = file.type.startsWith('video/');

                // Auto-switch media type
                const detectedType = isVideo ? "video" : "image";
                document.getElementById("mediaType").value = detectedType;

                // Update tabs
                document.querySelectorAll(".media-type-tab").forEach(t => {
                    t.classList.toggle("active", t.dataset.type === detectedType);
                });
                updateMediaTypeSections(detectedType);

                if (isVideo) {
                    videoPreview.src = URL.createObjectURL(file);
                    videoPreview.style.display = "block";
                    videoPreview.classList.add("visible");
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.add("visible");
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        // Load media from API
        async function loadMedia() {
            const grid = document.getElementById("mediaGrid");
            grid.innerHTML = `
        <div class="media-grid-loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `;

            try {
                const token = AuthManager.getAuthToken();
                let url = "/api/media";
                if (currentCategory !== "all") {
                    url += `?category=${currentCategory}`;
                }

                const response = await fetch(url, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = "/department-login";
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.media && data.media.length > 0) {
                    grid.innerHTML = data.media.map(item => renderMediaItem(item)).join("");

                    // Add event listeners to buttons


                    document.querySelectorAll(".delete-media-btn").forEach(btn => {
                        btn.addEventListener("click", (e) => {
                            e.stopPropagation();
                            currentMediaId = btn.dataset.id;
                            deleteConfirmModal.show();
                        });
                    });
                } else {
                    grid.innerHTML = `
            <div class="media-grid-empty" style="grid-column: 1 / -1;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <h5>No media found</h5>
              <p>Upload your first image to get started</p>
            </div>
          `;
                }
            } catch (error) {
                console.error("Error loading media:", error);
                grid.innerHTML = `
          <div class="media-grid-empty" style="grid-column: 1 / -1;">
            <p class="text-danger">Failed to load media</p>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadMedia()">Try Again</button>
          </div>
        `;
            }
        }

        // Render a single media item
        function renderMediaItem(item) {
            const mediaType = item.media_type || 'image';
            let mediaContent = '';

            // Build Badges Stack
            let badgesStack = [];
            // "for videos keep the video badge on top"
            if (mediaType === 'video') badgesStack.push('<span class="media-badge video">▶ Video</span>');
            if (item.is_featured) badgesStack.push('<span class="media-badge featured">★ Featured</span>');
            badgesStack.push(`<span class="media-badge category">${formatCategory(item.category)}</span>`);

            const badgesHTML = `<div class="media-badges-overlay">${badgesStack.join('')}</div>`;

            if (mediaType === 'video') {
                mediaContent = `<video src="${item.file_path}" muted></video>`;
            } else {
                mediaContent = `<img src="${item.file_path}" alt="${item.title}" loading="lazy" />`;
            }

            return `
        <div class="media-item" style="cursor: pointer;" onclick="editMedia('${item.id}')">
          ${badgesHTML}
          <div class="media-item-actions" onclick="event.stopPropagation()">
            <button class="btn btn-sm btn-danger delete-media-btn" data-id="${item.id}">Delete</button>
          </div>
          ${mediaContent}
          <div class="media-item-info">
            <div class="media-item-title">${item.title}</div>
          </div>
        </div>
      `;
        }

        // Format category name
        function formatCategory(cat) {
            const names = { events: "Events", camps: "Medical Camps", activities: "Activities", other: "Other" };
            return names[cat] || cat;
        }

        // Edit media
        async function editMedia(id) {
            try {
                const token = AuthManager.getAuthToken();
                const response = await fetch(`/api/media/${id}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();

                if (data.success && data.media) {
                    const media = data.media;

                    resetMediaForm();

                    document.getElementById("mediaId").value = media.id;
                    document.getElementById("mediaTitle").value = media.title || "";
                    document.getElementById("mediaDescription").value = media.description || "";
                    document.getElementById("mediaCategory").value = media.category || "other";
                    document.getElementById("mediaFeatured").checked = media.is_featured;

                    // Set media type
                    const mediaType = media.media_type || 'image';
                    document.getElementById("mediaType").value = mediaType;
                    document.querySelectorAll(".media-type-tab").forEach(t => {
                        t.classList.toggle("active", t.dataset.type === mediaType);
                    });
                    updateMediaTypeSections(mediaType);

                    // Show existing content based on type
                    const existingImageInfo = document.getElementById("existingImageInfo");
                    if (media.file_path) {
                        const isVideo = mediaType === 'video';
                        existingImageInfo.innerHTML = `
              <p class="mb-1"><strong>Current ${isVideo ? 'video' : 'image'}:</strong></p>
              ${isVideo
                                ? `<video src="${media.file_path}" style="max-width: 100%; max-height: 150px; border-radius: 8px;" controls></video>`
                                : `<img src="${media.file_path}" alt="${media.title}" style="max-width: 100%; max-height: 150px; border-radius: 8px;" />`
                            }
              <small class="d-block text-muted mt-1">Upload a new file to replace</small>
            `;
                        existingImageInfo.style.display = "block";
                    }

                    document.getElementById("mediaModalLabel").textContent = "Edit Media";
                    mediaModal.show();
                }
            } catch (error) {
                console.error("Error loading media details:", error);
                showAlert("Error loading media details", "danger");
            }
        }

        // Handle save media
        // Handle save media (Bulk Upload Support)
        async function handleSaveMedia() {
            const title = document.getElementById("mediaTitle").value.trim();
            // Title is required only for single/edit mode usually, but if bulk, we can reuse it or ignore?
            // User didn't specify, but let's require title if it's Edit.
            // For bulk, let's use filename if title is empty?

            const mediaId = document.getElementById("mediaId").value;
            const isEdit = mediaId !== "";
            const fileInput = document.getElementById("mediaFile");
            const selectedCategory = document.getElementById("mediaCategory").value;
            const isFeatured = document.getElementById("mediaFeatured").checked;
            const description = document.getElementById("mediaDescription").value;

            // Basic Validation
            if (!isEdit && fileInput.files.length === 0) {
                showAlert("Please select files", "danger");
                return;
            }

            // Show Spinner
            const saveBtn = document.getElementById("saveMediaBtn");
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...`;

            try {
                const token = AuthManager.getAuthToken();
                const files = fileInput.files;
                let successCount = 0;
                let errorCount = 0;

                // Handle Edit (Single Request)
                if (isEdit) {
                    const formData = new FormData();
                    formData.append("title", title); // Required for edit
                    formData.append("description", description);
                    formData.append("category", selectedCategory);
                    formData.append("is_featured", isFeatured);
                    formData.append("media_type", document.getElementById("mediaType").value);

                    if (files.length > 0) {
                        // Edit allows replacing file
                        const file = files[0];
                        if (file.size > 50 * 1024 * 1024) throw new Error("File too large (Max 50MB)");
                        formData.append("file", file);
                    }

                    const response = await fetch(`/api/media/${mediaId}`, {
                        method: "PUT",
                        headers: { Authorization: `Bearer ${token}` },
                        body: formData
                    });

                    if (!response.ok) throw new Error("Update failed");
                    successCount = 1;

                } else {
                    // Bulk Upload (Create)
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];

                        // Per-file Validation
                        if (file.size > 50 * 1024 * 1024) {
                            console.error(`File ${file.name} too large`);
                            errorCount++;
                            continue;
                        }

                        // Smart Detect Type
                        const isVideo = file.type.startsWith('video/');
                        const currentType = isVideo ? 'video' : 'image';

                        const formData = new FormData();
                        // Use provided title (with suffix if multiple) or fallback to filename
                        const itemTitle = title ? (files.length > 1 ? `${title} (${i + 1})` : title) : file.name;
                        formData.append("title", itemTitle);
                        formData.append("description", description);
                        formData.append("category", selectedCategory);
                        formData.append("is_featured", isFeatured);
                        formData.append("media_type", currentType);
                        formData.append("file", file);

                        const response = await fetch("/api/media", {
                            method: "POST",
                            headers: { Authorization: `Bearer ${token}` },
                            body: formData
                        });

                        if (response.ok) successCount++;
                        else errorCount++;
                    }
                }

                if (successCount > 0) {
                    showAlert(`Successfully saved ${successCount} files.${errorCount > 0 ? ` Failed: ${errorCount}` : ''}`, "success");
                    mediaModal.hide();
                    await loadMedia();
                } else {
                    throw new Error("Failed to save media");
                }

            } catch (error) {
                console.error("Error saving media:", error);
                showAlert(error.message || "Error saving media", "danger");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtnText;
            }
        }

        // Delete media
        async function deleteMedia(id) {
            try {
                const token = AuthManager.getAuthToken();
                const response = await fetch(`/api/media/${id}`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showAlert("Media deleted successfully", "success");
                    await loadMedia();
                } else {
                    throw new Error(data.message || "Failed to delete media");
                }
            } catch (error) {
                console.error("Error deleting media:", error);
                showAlert(error.message || "Error deleting media", "danger");
            }
        }

        // Reset form
        function resetMediaForm() {
            const form = document.getElementById("mediaForm");
            form.reset();
            document.getElementById("mediaId").value = "";
            document.getElementById("mediaType").value = "image";
            document.getElementById("imagePreview").classList.remove("visible");
            document.getElementById("videoPreview").style.display = "none";
            document.getElementById("videoPreview").classList.remove("visible");
            document.getElementById("existingImageInfo").style.display = "none";


            // Reset media type tabs
            document.querySelectorAll(".media-type-tab").forEach(t => {
                t.classList.toggle("active", t.dataset.type === "image");
            });
            updateMediaTypeSections("image");
        }

        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;

            const alertsContainer = document.querySelector(".alerts-container");
            alertsContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.remove("show");
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }
    </script>
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mediaModalLabel">Upload Media</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="mediaForm">
                        <input type="hidden" id="mediaId" value="" />

                        <div class="mb-3">
                            <label for="mediaTitle" class="form-label required-field">Title</label>
                            <input type="text" class="form-control" id="mediaTitle" required
                                placeholder="Enter image title" />
                        </div>

                        <div class="mb-3">
                            <label for="mediaDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="mediaDescription" rows="2"
                                placeholder="Enter description"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label required-field">Category</label>
                            <select class="form-select" id="mediaCategory" required>
                                <option value="other">Other</option>
                                <option value="events">Events</option>
                                <option value="camps">Medical Camps</option>
                                <option value="activities">Activities</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label required-field">Media Type</label>
                            <input type="hidden" id="mediaType" value="image" />
                            <div class="media-type-tabs">
                                <button type="button" class="media-type-tab active" data-type="image">Image</button>
                                <button type="button" class="media-type-tab" data-type="video">Video</button>

                            </div>
                        </div>

                        <!-- Image Upload Section -->
                        <div id="imageUploadSection" class="media-upload-section active">
                            <div class="upload-area" id="uploadArea">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="1.5">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12">
                                    </path>
                                </svg>
                                <p class="mb-1">Drag and drop a file here</p>
                                <p class="text-muted small mb-0">or click to browse</p>
                            </div>
                            <input type="file" class="form-control d-none" id="mediaFile" accept="image/*" multiple />

                            <div id="existingImageInfo" class="mb-3" style="display: none;">
                                <!-- Will be populated by JS -->
                            </div>

                            <div class="preview-container">
                                <div id="bulkPreview"
                                    class="alert alert-soft-primary mt-3 border-0 d-flex align-items-center"
                                    style="display: none;"></div>
                                <img id="imagePreview" class="image-preview" alt="Preview" />
                                <video id="videoPreview" class="video-preview" controls></video>
                            </div>
                        </div>



                        <div class="mb-3 form-check" id="featuredCheckContainer">
                            <input type="checkbox" class="form-check-input" id="mediaFeatured" />
                            <label class="form-check-label" for="mediaFeatured">Feature on Homepage</label>
                        </div>
                    </form>
                </div>
                <!-- Footer moved outside body for sticky scrollable behavior -->
                <div class="modal-footer">


                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveMediaBtn" form="mediaForm">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Save Media
                    </button>
                </div>

            </div>
        </div>
    </div>
    <script src="/admin/js/init.js"></script>
    <script src="/admin/js/mobile-menu.js"></script>
</body>

</html>